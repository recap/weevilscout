<weevil>
<name>zx1</name>
<parameters>
<sequence1 >
<sequence1.0>MDAMKRGLCCVLLLCGAVFVSPSQEIHARFRRGARSYQVICRDEKTQMIYQQHQSWLRPVLRSNRVEYCWCNSGRAQCHSVPVKSCSEPRCFNGGTCQQALYFSDFVCQCPEGFAGKCCEIDTRATCYEDQGISYRGTWSTAESGAECTNWNSSALAQKPYSGRRPDAIRLGLGNHNYCRNPDRDSKPWCYVFKAGKYSSEFCSTPACSEGNSDCYFGNGSAYRGTHSLTESGASCLPWNSMILIGKVYTAQNPSAQALGLGKHNYCRNPDGDAKPWCHVLKNRRLTWEYCDVPSCSTCGLRQYSQPQFRIKGGLFADIASHPWQAAIFAKHRRSPGERFLCGGILISSCWILSAAHCFQERFPPHHLTVILGRTYRVVPGEEEQKFEVEKYIVHKEFDDDTYDNDIALLQLKSDSSRCAQESSVVRTVCLPPADLQLPDWTECELSGYGKHEALSPFYSERLKEAHVRLYPSSRCTSQHLLNRTVTDNMLCAGDTRSGGPQANLHDACQGDSGGPLVCLNDGRMTLVGIISWGLGCGQKDVPGVYTKVTNYLDWIRDNMRP</sequence1.0>
</sequence1>
<sequence2 >
<sequence2.0>MDAMKRGLCCVLLLCGAVFVSPSQEIHARFRRGARSYQVICRDEKTQMIYQQHQSWLRPVLRSNRVEYCWCNSGRAQCHSVPVKSCSEPRCFNGGTCQQALYFSDFVCQCPEGFAGKCCEIDTRATCYEDQGISYRGTWSTAESGAECTNWNSSALAQKPYSGRRPDAIRLGLGNHNYCRNPDRDSKPWCYVFKAGKYSSEFCSTPACSEGNSDCYFGNGSAYRGTHSLTESGASCLPWNSMILIGKVYTAQNPSAQALGLGKHNYCRNPDGDAKPWCHVLKNRRLTWEYCDVPSCSTCGLRQYSQPQFRIKGGLFADIASHPWQAAIFAKHRRSPGERFLCGGILISSCWILSAAHCFQERFPPHHLTVILGRTYRVVPGEEEQKFEVEKYIVHKEFDDDTYDNDIALLQLKSDSSRCAQESSVVRTVCLPPADLQLPDWTECELSGYGKHEALSPFYSERLKEAHVRLYPSSRCTSQHLLNRTVTDNMLCAGDTRSGGPQANLHDACQGDSGGPLVCLNDGRMTLVGIISWGLGCGQKDVPGVYTKVTNYLDWIRDNMRP</sequence2.0>
</sequence2>
<type><type.0>null</type.0></type>
<score><score.0>null</score.0></score>
<mismatch_award><mismatch_award.0>null</mismatch_award.0></mismatch_award>
<mismatch_penalty><mismatch_penalty.0>null</mismatch_penalty.0></mismatch_penalty>
<matrix><matrix.0>null</matrix.0></matrix>
<penalty><penalty.0>null</penalty.0></penalty>
<linear_gap><linear_gap.0>null</linear_gap.0></linear_gap>
<open_gap><open_gap.0>null</open_gap.0></open_gap>
<prolongation_gap><prolongation_gap.0>null</prolongation_gap.0></prolongation_gap>
<output_format><output_format.0>null</output_format.0></output_format>
</parameters>
<source>// Based On OPAL ( http://opal.przyjaznycms.pl/en/ )
// Version: 1.0
// Author: Adam Skowron ( http://www.przyjaznycms.pl )
function weevil_main(sequence1, sequence2, type, score, mismatch_award, mismatch_penalty, matrix, penalty, linear_gap, open_gap, prolongation_gap, output_format) {
    var retStr = new String();
    var options = {};
    options.sequence1 = sequence1;
    options.sequence2 = sequence2;
    options.type = (type) ? type : 1;
    options.score = (score) ? score : 1;
    options.ma = (mismatch_award) ? mismatch_award : 1;
    options.mp = (mismatch_penalty) ? mismatch_penalty : 0;
    options.matrix = (matrix) ? matrix : &apos;blosum62&apos;;
    options.penalty = (penalty) ? penalty : &apos;linear&apos;;
    options.gp = (linear_gap) ? linear_gap : 0;
    options.gop = (open_gap) ? open_gap : 0;
    options.gpp = (prolongation_gap) ? prolongation_gap : 0;
    options.outputFormat = (output_format) ? output_format : &apos;html&apos;;

    //options = $.extend(defaults, options);
    var nucleotides = &apos;ACTG&apos;;
    var aminoacids = &apos;ACDEFGHIKLMNPQRSTVWY&apos;;
    var cols = options.sequence1.length + 1;
    var rows = options.sequence2.length + 1;
    var final_score = 0;
    var final_seq1 = &apos;&apos;,
    final_seq2 = &apos;&apos;,
    seq_line = &apos;&apos;;
    var S = new Array(); // macierz podstawien
    var F = new Array(); // macierz finalna
    var _self = this;

    //_getSubstitutionMatrix(options.matrix);
    //return;
    _init();
    _fill();
    _autoalign();

    function _init() {
        (options.score == 2) ? _getSubstitutionMatrix(options.matrix) : ((options.type == 1) ? _createSubstitutionMatrix(nucleotides) : _createSubstitutionMatrix(aminoacids));
        var i = 0,
        j = 0;
        options.sequence1 = _reverse(options.sequence1);
        options.sequence2 = _reverse(options.sequence2);
        for (i = 0; i &lt; rows; i++) {
            F[i] = new Array();
            for (j = 0; j &lt; cols; j++)
            F[i][j] = (i == 0 &amp;&amp; j == 0) ? 0 : (i == 0) ? _gap(j + 1) : ((j == 0) ? _gap(i + 1) : 0);
        }
    }

    function _createSubstitutionMatrix(t) {
        if (t.length &gt; 0) {
            for (var i = 0; i &lt; t.length; i++) {
                for (var j = 0; j &lt; t.length; j++) {
                    S[t.charAt(i) + t.charAt(j)] = (t.charAt(i) == t.charAt(j)) ? options.ma : options.mp;
                }
            }
        }
    }
    function _getSubstitutionMatrix(name) {
        var data = {};
        var http_request = new XMLHttpRequest();
        http_request.open(&quot;GET&quot;, &apos;/~weevil/weevils/SequenceAlignment-NW/js/matrices/&apos; + name + &apos;.json&apos;, false);
        http_request.onreadystatechange = function() {
            if (http_request.readyState == 4 &amp;&amp; http_request.status == 200) {
                data = JSON.parse(http_request.responseText);
                ////alert(data[2][3]);
                var len = (options.type == 1) ? 4 : 20;
                for (var i = 0; i &lt; len; i++) {
                    for (var j = 0; j &lt; len; j++) {
                        if (options.type == 1) S[nucleotides.charAt(i) + nucleotides.charAt(j)] = parseInt(data[i][j]);
                        else S[aminoacids.charAt(i) + aminoacids.charAt(j)] = parseInt(data[i][j]);
                    }
                }

            } else {
                return;
            }
        };
        http_request.send(null);
    }

    function _reverse(text) {
        return text.split(&apos;&apos;).reverse().join(&apos;&apos;);
    }

    function _gap(i) {
        i = i - 1;
        return (options.penalty == &apos;linear&apos;) ? options.gp * i : ((i &gt; 0) ? options.gop + options.gpp * (i) : options.gop);
    }

    function _round(number, x) {
        var x = (!x ? 2 : x);
        return Math.round(number * Math.pow(10, x)) / Math.pow(10, x);
    }

    function _fill() {

        var i, j;
        for (i = 1; i &lt; rows; i++) {
            for (j = 1; j &lt; cols; j++) {
                var tF = _round(_calcCondition(i, j), 2);
                if (isNaN(tF)) {
                    F[i][j] = 0;
                } else {
                    F[i][j] = tF;
                }

            }
        }
    }

    function _calcCondition(i, j) {
        var choice1, choice2, choice3, k, _c2, _c3, ch1, ch2;
        ch1 = i - 1;
        ch2 = j - 1;

        choice1 = S[options.sequence2.charAt(ch1) + options.sequence1.charAt(ch2)] + F[i - 1][j - 1];
        choice2 = -1000;
        for (k = 1; k &lt; i; k++) {
            _c2 = S[options.sequence2.charAt(ch1) + options.sequence1.charAt(ch2)] + F[i - k][j - 1] + _gap(k);
            if (_c2 &gt; choice2) choice2 = _c2;
        }
        choice3 = -1000;
        for (k = 1; k &lt; j; k++) {
            _c3 = S[options.sequence2.charAt(ch1) + options.sequence1.charAt(ch2)] + F[i - 1][j - k] + _gap(k);
            if (_c3 &gt; choice3) choice3 = _c3;
        }
        return Math.max(choice1, choice2, choice3);
    }

    function _seqline(s1, s2) {
        if (options.type == 1) {
            if (s1 == s2) {
                return &quot;|&quot;;
            }
            else if (s1 == &apos;-&apos; || s2 == &apos;-&apos;) {
                return &quot;&amp;nbsp;&quot;;
            }
            else {
                return &quot;x&quot;;
            }
        }
        else {
            if (s1 == s2) {
                return &quot;|&quot;;
            }
            else if (options.score == 2 &amp;&amp; S[s1 + s2] &gt;= 0) {
                return &quot;.&quot;;
            }
            else if (s1 == &apos;-&apos; || s2 == &apos;-&apos;) {
                return &quot;&amp;nbsp;&quot;;
            }
            else {
                return &quot;x&quot;;
            }
        }
    }

    function _autoalign() {
        var i = rows - 1; // seq2
        var j = cols - 1; // seq1
        var s, s_right, s_bottom, k, ch1, ch2, _c2, _c3, min_i, min_j, max_temp;
        while (i &gt; 0 &amp;&amp; j &gt; 0) {
            s_right = -100000;
            s_bottom = -100000;
            s = F[i][j];
            ch2 = i - 1;
            ch1 = j - 1;

            for (k = 1; k &lt; i; k++) {
                if (F[i - k][j - 1] &gt; s_bottom) {
                    min_i = k;
                    s_bottom = F[i - k][j - 1];
                }
            }

            for (k = 1; k &lt; j; k++) {
                if (F[i - 1][j - k] &gt; s_right) {
                    min_j = k;
                    s_right = F[i - 1][j - k];
                }
            }

            max_temp = Math.max(F[i - 1][j - 1], s_right, s_bottom);
            if (max_temp == F[i - 1][j - 1]) {
                final_seq1 += options.sequence1.charAt(ch1);
                final_seq2 += options.sequence2.charAt(ch2);
                seq_line += _seqline(options.sequence1.charAt(ch1), options.sequence2.charAt(ch2));
                --i;
                --j;
            }
            else if (max_temp == s_right) {
                final_seq1 += options.sequence1.charAt(ch1);
                final_seq2 += options.sequence2.charAt(ch2);
                seq_line += _seqline(options.sequence1.charAt(ch1), options.sequence2.charAt(ch2));
                for (var z = 1; z &lt; min_j; z++) {
                    final_seq1 += options.sequence1.charAt(ch1 - z);
                    final_seq2 += &apos;-&apos;;
                    seq_line += _seqline(options.sequence1.charAt(ch1 - z), &apos;-&apos;);
                }
                j -= min_j;
                i -= 1;
            }
            else if (max_temp == s_bottom) {
                final_seq1 += options.sequence1.charAt(ch1);
                final_seq2 += options.sequence2.charAt(ch2);
                seq_line += _seqline(options.sequence1.charAt(ch1), options.sequence2.charAt(ch2));
                for (var z = 1; z &lt; min_i; z++) {
                    final_seq2 += options.sequence2.charAt(ch2 - z);
                    final_seq1 += &apos;-&apos;;
                    seq_line += _seqline(&apos;-&apos;, options.sequence2.charAt(ch2 - z));
                }
                i -= min_i;
                j -= 1;
            }
        }
        while (i &gt; 0) {
            s_right = -100000;
            s_bottom = -100000;
            final_seq2 += options.sequence2.charAt(i - 1);
            final_seq1 += &apos;-&apos;;
            seq_line += _seqline(&apos;-&apos;, options.sequence2.charAt(i - 1));
            --i;
        }

        while (j &gt; 0) {
            final_seq1 += options.sequence1.charAt(j - 1);
            final_seq2 += &apos;-&apos;;
            seq_line += _seqline(options.sequence1.charAt(j - 1), &apos;-&apos;);
            --j;
        }
        if (options.outputFormat == &apos;html&apos;) {
            retStr = retStr + &apos;&lt;br /&gt;&lt;b&gt;&apos; + options.sequence1 + &apos; || &apos; + options.sequence2 + &apos;:&lt;/b&gt;&lt;br /&gt;&apos; + final_seq1 + &apos;&lt;br /&gt;&apos; + seq_line + &apos;&lt;br /&gt;&apos; + final_seq2;
        }
        if (options.outputFormat == &apos;xml&apos;) {
            retStr = retStr + &apos;&lt;header&gt;&apos; + options.sequence1 + &apos; || &apos; + options.sequence2 + &apos;:&lt;/header&gt;&lt;seq1&gt;&apos; + final_seq1 + &apos;&lt;/seq1&gt;&lt;seqline&gt;&apos; + seq_line + &apos;&lt;/seqline&gt;&lt;seq2&gt;&apos; + final_seq2 + &apos;&lt;/seq2&gt;&apos;;
        }
        _autoscore();
    }

    var align_i = rows - 1,
    align_j = cols - 1;
    function _align(i, j) {
        var timeoutID;
        if (i &gt; 0 &amp;&amp; j &gt; 0) {
            var s, s_right, s_bottom, k, ch1, ch2, _c2, _c3, min_i, min_j, max_temp;
            s_right = -100000;
            s_bottom = -100000;
            s = F[i][j];
            ch2 = i - 1;
            ch1 = j - 1;

            for (k = 1; k &lt; i; k++) {
                if (F[i - k][j - 1] &gt; s_bottom) {
                    min_i = k;
                    s_bottom = F[i - k][j - 1];
                }
            }

            for (k = 1; k &lt; j; k++) {
                if (F[i - 1][j - k] &gt; s_right) {
                    min_j = k;
                    s_right = F[i - 1][j - k];
                }
            }

            max_temp = Math.max(F[i - 1][j - 1], s_right, s_bottom);

            if (max_temp == F[i - 1][j - 1]) {
                final_seq1 += options.sequence1.charAt(ch1);
                final_seq2 += options.sequence2.charAt(ch2);
                seq_line += _seqline(options.sequence1.charAt(ch1), options.sequence2.charAt(ch2));
                --i;
                --j;
            }
            else if (max_temp == s_right) {
                final_seq1 += options.sequence1.charAt(ch1);
                final_seq2 += options.sequence2.charAt(ch2);
                seq_line += _seqline(options.sequence1.charAt(ch1), options.sequence2.charAt(ch2));
                for (var z = 1; z &lt; min_j; z++) {
                    final_seq1 += options.sequence1.charAt(ch1 - z);
                    final_seq2 += &apos;-&apos;;
                    seq_line += _seqline(options.sequence1.charAt(ch1 - z), &apos;-&apos;);
                }
                j -= min_j;
                i -= 1;
            }
            else if (max_temp == s_bottom) {
                final_seq1 += options.sequence1.charAt(ch1);
                final_seq2 += options.sequence2.charAt(ch2);
                seq_line += _seqline(options.sequence1.charAt(ch1), options.sequence2.charAt(ch2));
                for (var z = 1; z &lt; min_i; z++) {
                    final_seq2 += options.sequence2.charAt(ch2 - z);
                    final_seq1 += &apos;-&apos;;
                    seq_line += _seqline(&apos;-&apos;, options.sequence2.charAt(ch2 - z));
                }
                i -= min_i;
                j -= 1;
            }
            align_i = i;
            align_j = j;
            timeoutID = setTimeout(function() {
                _align(i, j)
            },
            options.pause);
        } else {
            while (i &gt; 0) {
                final_seq2 += options.sequence2.charAt(i - 1);
                final_seq1 += &apos;-&apos;;
                seq_line += _seqline(&apos;-&apos;, options.sequence2.charAt(i - 1));
                --i;
            }
            while (j &gt; 0) {
                final_seq1 += options.sequence1.charAt(j - 1);
                final_seq2 += &apos;-&apos;;
                seq_line += _seqline(options.sequence1.charAt(j - 1), &apos;-&apos;);
                --j;
            }
            clearTimeout(timeoutID);
            if (options.outputFormat == &apos;html&apos;) {
                retStr = retStr + &apos;&lt;br /&gt;&lt;b&gt;&apos; + options.sequence1 + &apos; || &apos; + options.sequence2 + &apos;:&lt;/b&gt;&lt;br /&gt;&apos; + final_seq1 + &apos;&lt;br /&gt;&apos; + seq_line + &apos;&lt;br /&gt;&apos; + final_seq2;
            }
            if (options.outputFormat == &apos;xml&apos;) {
                retStr = retStr + &apos;&lt;header&gt;&apos; + options.sequence1 + &apos; || &apos; + options.sequence2 + &apos;:&lt;/header&gt;&lt;seq1&gt;&apos; + final_seq1 + &apos;&lt;/seq1&gt;&lt;seqline&gt;&apos; + seq_line + &apos;&lt;/seqline&gt;&lt;seq2&gt;&apos; + final_seq2 + &apos;&lt;/seq2&gt;&apos;;
            }
            _autoscore();
        }
    }

    function _autoscore() {
        var gap_prolongate = 0;
        for (var i = 0; i &lt; final_seq1.length; i++) {
            if (final_seq1.charAt(i) == &apos;-&apos; || final_seq2.charAt(i) == &apos;-&apos;) {
                ++gap_prolongate;
                if (final_seq1.length == (i + 1)) {
                    final_score += _gap(gap_prolongate + 1);
                }
            }
            else {
                if (gap_prolongate &gt; 0) {
                    final_score += _gap(gap_prolongate + 1);
                }
                gap_prolongate = 0;
                final_score += S[final_seq1.charAt(i) + final_seq2.charAt(i)];
            }
        }
        if (options.outputFormat == &apos;html&apos;) {
            retStr = retStr + &apos;&lt;br /&gt;&lt;b&gt;score: &lt;/b&gt;&apos; + _round(final_score, 2);
        }
        if (options.outputFormat == &apos;xml&apos;) {
            retStr = retStr + &apos;&lt;score&gt;&apos; + _round(final_score, 2) + &apos;&lt;/score&gt;&apos;;
        }

    }
    return retStr;
}
</source>
</weevil>